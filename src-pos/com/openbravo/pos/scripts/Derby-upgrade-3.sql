--    POS-tech is a point of sales software
--    Copyright (C) 2012 SARL SCOP Scil
--    http://trac.scil.coop/pos-tech
--
--    This file is part of POS-Tech
--
--    POS-tech is free software: you can redistribute it and/or modify
--    it under the terms of the GNU General Public License as published by
--    the Free Software Foundation, either version 3 of the License, or
--    (at your option) any later version.
--
--    POS-tech is distributed in the hope that it will be useful,
--    but WITHOUT ANY WARRANTY; without even the implied warranty of
--    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
--    GNU General Public License for more details.
--
--    You should have received a copy of the GNU General Public License
--    along with POS-tech. If not, see <http://www.gnu.org/licenses/>.

-- Database upgrade script for DERBY

-- db v3 - v4

-- final script
CREATE TABLE SUBGROUPS (
    ID VARCHAR(256) NOT NULL,
    COMPOSITION VARCHAR(256) NOT NULL,
    NAME VARCHAR(256) NOT NULL,
    IMAGE BLOB,
    DISPORDER INTEGER DEFAULT NULL,
    PRIMARY KEY(ID),
    CONSTRAINT SUBGROUPS_FK_1 FOREIGN KEY (COMPOSITION) REFERENCES PRODUCTS(ID) ON DELETE CASCADE
);

CREATE TABLE SUBGROUPS_PROD (
    SUBGROUP VARCHAR(256) NOT NULL,
    PRODUCT VARCHAR(256) NOT NULL,
    DISPORDER INTEGER DEFAULT NULL,
    PRIMARY KEY (SUBGROUP, PRODUCT),
    CONSTRAINT SUBGROUPS_PROD_FK_1 FOREIGN KEY (SUBGROUP) REFERENCES SUBGROUPS(ID) ON DELETE CASCADE,
    CONSTRAINT SUBGROUPS_PROD_FK_2 FOREIGN KEY (PRODUCT) REFERENCES PRODUCTS(ID) ON DELETE CASCADE
);

INSERT INTO CATEGORIES(ID, NAME) VALUES ('0', 'Formules');
INSERT INTO CATEGORIES(ID, NAME) VALUES ('-1', 'Pré-paiement');

CREATE TABLE TARIFFAREAS (
    ID VARCHAR(255) NOT NULL,
    NAME VARCHAR(255) NOT NULL,
    TARIFFORDER INTEGER DEFAULT 0,
    PRIMARY KEY(ID)
);
CREATE UNIQUE INDEX TARIFFAREAS_NAME_INX ON TARIFFAREAS(NAME);

CREATE TABLE TARIFFAREAS_PROD (
    TARIFFID VARCHAR(255) NOT NULL,
    PRODUCTID VARCHAR(256) NOT NULL,
    PRICESELL DOUBLE PRECISION NOT NULL,
    PRIMARY KEY (TARIFFID, PRODUCTID),
    CONSTRAINT TARIFFAREAS_PROD_FK_1 FOREIGN KEY (TARIFFID) REFERENCES TARIFFAREAS(ID) ON DELETE CASCADE,
    CONSTRAINT TARIFFAREAS_PROD_FK_2 FOREIGN KEY (PRODUCTID) REFERENCES PRODUCTS(ID) ON DELETE CASCADE
);


ALTER TABLE CATEGORIES ADD COLUMN DISPORDER INTEGER DEFAULT NULL;
ALTER TABLE PRODUCTS ADD COLUMN DELETED SMALLINT DEFAULT 0 NOT NULL;

ALTER TABLE TICKETS ADD COLUMN TARIFFAREA VARCHAR(255) DEFAULT NULL;
ALTER TABLE TICKETS ADD CONSTRAINT TICKETS_TARIFFAREA FOREIGN KEY (TARIFFAREA) REFERENCES TARIFFAREAS(ID);

ALTER TABLE CUSTOMERS ADD COLUMN PREPAID DOUBLE PRECISION DEFAULT 0 NOT NULL;

CREATE TABLE CURRENCIES (
    ID INTEGER NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    NAME VARCHAR(256) NOT NULL,
    SYMBOL VARCHAR(10) DEFAULT NULL,
    DECIMALSEP VARCHAR(1) DEFAULT NULL,
    THOUSANDSSEP VARCHAR(1) DEFAULT NULL,
    RATE DOUBLE PRECISION DEFAULT 1.0 NOT NULL,
    FORMAT VARCHAR(20) DEFAULT '#0.00 $' NOT NULL,
    MAIN SMALLINT NOT NULL,
    ACTIVE SMALLINT DEFAULT 1 NOT NULL,
    PRIMARY KEY (ID)
);
INSERT INTO CURRENCIES (ID, NAME, SYMBOL, DECIMALSEP, THOUSANDSSEP, RATE, FORMAT, MAIN) VALUES
(1, 'Euro', '€', ',', ' ', 1, '#,##0.00 $', 1);
ALTER TABLE PAYMENTS ADD COLUMN CURRENCY INTEGER NOT NULL DEFAULT 1;
ALTER TABLE PAYMENTS ADD COLUMN TOTALCURRENCY DOUBLE PRECISION NOT NULL DEFAULT 1.0;
UPDATE PAYMENTS SET CURRENCY = 1, TOTALCURRENCY = TOTAL;
ALTER TABLE PAYMENTS ADD CONSTRAINT PAYMENTS_FK_CURRENCY FOREIGN KEY (CURRENCY) REFERENCES CURRENCIES(ID);

UPDATE APPLICATIONS SET NAME = $APP_NAME{}, VERSION = '4' WHERE ID = $APP_ID{};
